# HEPHAITOS 환불 정책

> **최종 업데이트**: 2025-12-16
> **버전**: 1.0
> **상태**: 확정 (법무 검토 권장)

---

## 1. 기본 원칙

HEPHAITOS는 **크레딧 기반 선불제** 서비스로, 아래 조건에 따라 환불을 제공합니다.

### 핵심 원칙
- ✅ **미사용 크레딧은 환불 가능** (조건부)
- ❌ **사용한 크레딧은 환불 불가** (API 호출 비용 이미 발생)
- ⚠️ **증권 연동 후 실거래 발생 시 환불 제한**

---

## 2. 환불 조건

### 2.1 전액 환불 (100%)

| 조건 | 기준 | 예시 |
|------|------|------|
| 구매 후 7일 이내 | 미사용 크레딧 80% 이상 | 100 크레딧 구매 → 80개 이상 남음 |
| 서비스 장애 | HEPHAITOS 귀책사유 | API 장애로 전략 생성 실패 |
| 중복 결제 | 시스템 오류로 2회 이상 결제 | 멱등성 실패 케이스 |

**환불 방법**: 원 결제 수단으로 전액 환불

### 2.2 부분 환불 (비례)

| 조건 | 계산 방식 | 예시 |
|------|----------|------|
| 구매 후 7일 이내 | 미사용 크레딧 비율 × 결제 금액 | 100개 중 60개 사용 → 40% 환불 |
| 미사용 크레딧 80% 미만 | | 100개 중 25개 사용 → 75% 환불 |

**계산식**:
```
환불 금액 = 결제 금액 × (미사용 크레딧 / 총 크레딧)
최소 환불: ₩1,000 (수수료 고려)
```

### 2.3 환불 불가

| 조건 | 사유 |
|------|------|
| 구매 후 7일 초과 | 전자상거래법 청약철회 기간 경과 |
| 미사용 크레딧 20% 미만 | 실질적으로 서비스 사용 완료 |
| 증권 연동 후 실거래 발생 | 실제 주문 체결로 서비스 제공 완료 |
| 어뷰징 감지 | 반복 구매/환불, 크레딧 대량 소진 후 환불 요청 |

---

## 3. 환불 프로세스

### 3.1 환불 요청 방법

1. **이메일 요청**
   - 수신: refund@ioblock.io
   - 제목: `[환불 요청] 주문번호 {order_id}`
   - 필수 정보:
     - 주문번호 (order_id)
     - 결제일
     - 결제 금액
     - 환불 사유

2. **대시보드에서 요청** (향후 구현)
   - `/dashboard/settings/billing` → "환불 요청" 버튼
   - 자동으로 미사용 크레딧 계산

### 3.2 환불 처리 기간

| 단계 | 소요 시간 | 담당 |
|------|----------|------|
| 요청 접수 | 즉시 | 자동 시스템 |
| 검토 및 승인 | 1-2 영업일 | CS 팀 |
| 환불 처리 (토스) | 3-5 영업일 | 토스페이먼츠 |
| 카드사 입금 | 2-3 영업일 | 카드사 |

**총 소요**: 최대 10 영업일

---

## 4. 환불 금액 계산 예시

### 예시 1: 전액 환불 (7일 이내, 80% 이상 미사용)
```
구매: 스타터 100 크레딧 (₩9,900)
사용: 15 크레딧 (전략 생성 1회)
미사용: 85 크레딧 (85%)

→ 조건 충족: 7일 이내 + 80% 이상
→ 환불 금액: ₩9,900 (전액)
```

### 예시 2: 부분 환불 (7일 이내, 40% 미사용)
```
구매: 베이직 500 크레딧 (₩39,000)
사용: 300 크레딧 (전략 10회 + 백테스트 20회)
미사용: 200 크레딧 (40%)

→ 조건 충족: 7일 이내, 부분 사용
→ 환불 금액: ₩39,000 × 0.4 = ₩15,600
```

### 예시 3: 환불 불가 (7일 이내, 실거래 발생)
```
구매: 프로 1,000 크레딧 (₩69,000)
사용: 50 크레딧 (전략 2회)
미사용: 950 크레딧 (95%)
특이사항: 한국투자증권 연동 후 매수 주문 1건 체결

→ 환불 불가 사유: 증권 연동 후 실거래 발생
→ 서비스 제공 완료로 간주
```

### 예시 4: 환불 불가 (7일 초과)
```
구매: 스타터 100 크레딧 (₩9,900)
구매일: 2025-12-01
환불 요청일: 2025-12-10 (9일 경과)
미사용: 100 크레딧 (100%)

→ 환불 불가 사유: 청약철회 기간(7일) 경과
```

---

## 5. 크레딧 회수 로직

### DB 트랜잭션
```sql
-- 환불 시 크레딧 회수 (원자적 처리)
begin;

-- 1. 주문 상태 확인
select * from payment_orders
where order_id = {order_id}
and status = 'paid'
for update;

-- 2. 미사용 크레딧 계산
select balance from credit_wallets
where user_id = {user_id}
for update;

-- 미사용 크레딧 = min(현재 잔액, 구매한 크레딧)
-- 예: 구매 100개, 현재 잔액 40개 → 회수 40개

-- 3. 환불 금액 계산
refund_amount = order.amount × (unused_credits / order.credits)

-- 4. 크레딧 회수
insert into credit_transactions (user_id, type, amount, metadata, payment_order_id)
values ({user_id}, 'refund', -{unused_credits}, {...}, {order_id});

update credit_wallets
set balance = balance - {unused_credits}
where user_id = {user_id};

-- 5. 주문 상태 변경
update payment_orders
set status = 'refunded', refunded_at = now()
where order_id = {order_id};

commit;
```

---

## 6. 토스페이먼츠 환불 API 연동

### 환불 요청
```typescript
// src/app/api/payments/refund/route.ts
const tossRes = await fetch(
  `https://api.tosspayments.com/v1/payments/${paymentKey}/cancel`,
  {
    method: 'POST',
    headers: {
      'Authorization': `Basic ${Buffer.from(`${process.env.TOSS_SECRET_KEY!}:`).toString('base64')}`,
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      cancelReason: '고객 요청 환불',
      cancelAmount: refundAmount,  // 부분 환불 가능
    }),
  }
);
```

### 환불 응답
```json
{
  "paymentKey": "tgen_xxx",
  "orderId": "order_1702999999_abc123",
  "status": "CANCELED",
  "cancels": [
    {
      "cancelAmount": 15600,
      "cancelReason": "고객 요청 환불",
      "canceledAt": "2025-12-16T12:34:56+09:00",
      "cancelStatus": "DONE"
    }
  ]
}
```

---

## 7. 고객 안내 문구

### 결제 페이지 (구매 전)
```
환불 정책 안내

• 구매 후 7일 이내, 미사용 크레딧 80% 이상 시 전액 환불 가능
• 부분 사용 시 미사용 크레딧 비율만큼 환불 (최소 ₩1,000)
• 증권 연동 후 실거래 발생 시 환불 불가
• 환불 처리 기간: 최대 10 영업일

자세한 내용은 환불 정책을 확인하세요.
```

### 환불 요청 모달
```
환불 가능 금액: ₩{계산된 금액}

현재 잔액: {balance} 크레딧
구매 크레딧: {purchased} 크레딧
미사용 비율: {unused_ratio}%

환불 사유를 선택해주세요:
□ 서비스가 기대와 다름
□ 사용법을 몰라서
□ 증권 연동이 어려움
□ 기타: ___________

[환불 요청하기]
```

---

## 8. 어뷰징 방지

### 감지 기준
| 패턴 | 판단 | 조치 |
|------|------|------|
| 7일 내 3회 이상 구매/환불 | 어뷰징 의심 | 수동 검토 |
| 크레딧 95% 소진 후 환불 요청 | 악용 의심 | 환불 거부 |
| 동일 IP에서 여러 계정 환불 | 조직적 어뷰징 | 계정 차단 |

### 모니터링 SQL
```sql
-- 반복 환불 사용자 감지
select user_id, count(*) as refund_count
from payment_orders
where status = 'refunded'
and refunded_at > now() - interval '30 days'
group by user_id
having count(*) >= 3;
```

---

## 9. 법적 근거

### 전자상거래법
- **청약철회 기간**: 구매 후 7일 이내
- **디지털 콘텐츠**: 일부 사용 시 비례 환불 가능
- **공급자 귀책**: 서비스 장애 시 전액 환불 의무

### 약관 명시 사항
```
제15조 (청약철회 및 환불)
① 회원은 크레딧 구매 후 7일 이내에 청약철회를 할 수 있습니다.
② 미사용 크레딧 80% 이상 시 전액 환불, 80% 미만 시 비례 환불합니다.
③ 다음의 경우 환불이 제한됩니다:
   1. 청약철회 기간(7일) 경과
   2. 증권사 연동 후 실거래 발생
   3. 미사용 크레딧 20% 미만
④ 환불은 원 결제 수단으로 처리되며, 최대 10 영업일 소요됩니다.
```

---

## 10. CS 대응 가이드

### FAQ
**Q1. 크레딧을 하나도 안 썼는데 7일이 지나면 환불이 안 되나요?**
A1. 네, 전자상거래법상 청약철회 기간(7일)이 경과하면 환불이 어렵습니다. 단, 서비스 장애 등 당사 귀책사유가 있는 경우 예외적으로 검토 가능합니다.

**Q2. 전략 생성 1번 했는데 전액 환불 가능한가요?**
A2. 100 크레딧 구매 시 전략 생성 1회(10 크레딧)면 미사용 90%, 전액 환불 조건(80% 이상)을 충족하여 가능합니다.

**Q3. 환불 후 크레딧은 어떻게 되나요?**
A3. 환불 승인 시 미사용 크레딧이 자동으로 회수되며, 잔액이 0이 됩니다.

**Q4. 증권 연동만 하고 실거래를 안 했는데도 환불이 안 되나요?**
A4. 연동만 하고 실거래가 없으면 환불 가능합니다. "실거래 발생"은 실제 주문 체결을 의미합니다.

---

## 11. 향후 개선 사항

### Phase 1 (베타)
- [x] 환불 정책 문서화
- [ ] 환불 API 구현 (`/api/payments/refund`)
- [ ] 이메일 기반 수동 처리

### Phase 2 (정식 출시)
- [ ] 대시보드 "환불 요청" 버튼
- [ ] 자동 미사용 크레딧 계산
- [ ] 환불 진행 상황 추적 UI

### Phase 3 (고도화)
- [ ] 어뷰징 자동 감지 시스템
- [ ] 환불 사유 분석 대시보드
- [ ] 크레딧 양도/선물 기능 (환불 대안)

---

*이 정책은 법무 검토를 거쳐 최종 확정되어야 합니다.*
*베타 기간 중 실제 환불 케이스를 수집하여 정책을 보완할 예정입니다.*
