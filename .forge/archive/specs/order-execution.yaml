# QRY-007: Order Execution
# HEPHAITOS - 매매 주문 실행 및 포지션 관리

query_id: QRY-007
app: hephaitos
feature: order-execution
version: 1.0.0
created: 2025-12-19

# ═══════════════════════════════════════════════════════════════
# 개요
# ═══════════════════════════════════════════════════════════════
description: |
  트레이딩 전략 신호에 따른 주문 실행 및 포지션 관리 시스템.
  시뮬레이션/페이퍼 트레이딩과 실거래 모드 지원.

goals:
  - 주문 생성 및 실행 관리
  - 포지션 추적 및 손익 계산
  - 리스크 관리 (손절/익절)
  - 주문 이력 및 실행 통계

# ═══════════════════════════════════════════════════════════════
# 나노팩터 계층 구조
# ═══════════════════════════════════════════════════════════════
layers:
  L0_types:
    path: packages/types/src/hephaitos/order.ts
    entities:
      - OrderSide (buy/sell)
      - OrderType (market/limit/stop/stop_limit)
      - OrderStatus (pending/open/filled/partial/cancelled/rejected)
      - IOrder (주문 정의)
      - IOrderExecution (체결 정보)
      - IPosition (포지션)
      - IPositionUpdate (포지션 변경)
      - IRiskConfig (리스크 설정)

  L1_utils:
    path: packages/utils/src/order-calc.ts
    functions:
      - calculatePositionSize: 자금관리 기반 포지션 크기
      - calculateRequiredMargin: 필요 증거금
      - calculateLeverage: 레버리지 계산
      - calculateStopLoss: 손절가 계산
      - calculateTakeProfit: 익절가 계산
      - calculatePnL: 실현/미실현 손익
      - calculateAvgEntryPrice: 평균 진입가
      - calculateRiskRewardRatio: 리스크/보상 비율
      - validateOrder: 주문 유효성 검증

  L2_repositories:
    path: packages/core/src/repositories/order-repository.ts
    interfaces:
      - IOrderRepository: 주문 CRUD
      - IPositionRepository: 포지션 CRUD
    implementations:
      - InMemoryOrderRepository
      - InMemoryPositionRepository

  L3_agent:
    path: apps/hephaitos/src/agents/order-executor-agent.ts
    class: OrderExecutorAgent
    methods:
      - submitOrder: 주문 제출
      - cancelOrder: 주문 취소
      - modifyOrder: 주문 수정
      - getOpenOrders: 미체결 주문 조회
      - getPosition: 포지션 조회
      - closePosition: 포지션 청산
      - getOrderHistory: 주문 이력
      - getExecutionStats: 실행 통계

# ═══════════════════════════════════════════════════════════════
# 주문 흐름
# ═══════════════════════════════════════════════════════════════
workflow:
  1_signal_received: |
    전략 에이전트로부터 매매 신호 수신
    - entry/exit 신호
    - 목표가, 손절가 포함

  2_risk_check: |
    리스크 검증
    - 최대 포지션 크기 확인
    - 일일 손실 한도 확인
    - 동시 포지션 수 확인

  3_order_creation: |
    주문 생성
    - 포지션 크기 계산
    - 주문 타입 결정
    - 손절/익절 주문 연결

  4_execution: |
    주문 실행 (시뮬레이션 또는 실거래)
    - 슬리피지 적용
    - 부분 체결 처리
    - 체결 확인

  5_position_update: |
    포지션 업데이트
    - 평균 진입가 재계산
    - 미실현 손익 계산
    - 마진 사용량 업데이트

# ═══════════════════════════════════════════════════════════════
# 리스크 관리
# ═══════════════════════════════════════════════════════════════
risk_management:
  position_sizing:
    - fixed_amount: 고정 금액
    - percent_equity: 자본금 비율
    - kelly_criterion: 켈리 기준
    - volatility_adjusted: 변동성 조정

  stop_loss:
    - fixed_percent: 고정 비율
    - atr_based: ATR 기반
    - trailing: 추적 손절
    - time_based: 시간 기반

  take_profit:
    - fixed_ratio: 고정 R:R 비율
    - partial_exit: 분할 익절
    - trailing: 추적 익절

# ═══════════════════════════════════════════════════════════════
# 면책조항 (필수)
# ═══════════════════════════════════════════════════════════════
disclaimer: |
  ⚠️ 중요 안내
  - 본 시스템은 교육 및 시뮬레이션 목적입니다
  - 실제 투자 조언이 아닙니다
  - 투자 결정에 따른 손실은 본인 책임입니다
