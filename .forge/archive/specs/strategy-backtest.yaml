# ═══════════════════════════════════════════════════════════════
# QRY-004: HEPHAITOS 전략 백테스팅
# ═══════════════════════════════════════════════════════════════

query_id: QRY-004
app: hephaitos
feature: strategy-backtest
created_at: 2024-12-19
status: in_progress

# ───────────────────────────────────────────────────────────────
# 기능 개요
# ───────────────────────────────────────────────────────────────

overview:
  name: 전략 백테스팅 시스템
  description: |
    과거 가격 데이터를 기반으로 트레이딩 전략의 성과를 시뮬레이션
    Copy→Learn→Build 교육 플랫폼의 핵심 기능

  value_proposition:
    - 실제 투자 전 전략 검증
    - 리스크 지표 (최대 낙폭, 샤프 비율) 사전 파악
    - 전략 파라미터 최적화 지원

# ───────────────────────────────────────────────────────────────
# 사용자 스토리
# ───────────────────────────────────────────────────────────────

user_stories:
  - id: US-001
    as: 트레이더
    want: 내 전략을 과거 데이터로 테스트
    so_that: 실제 투자 전 성과를 예측

  - id: US-002
    as: 학습자
    want: 다양한 전략의 백테스트 결과 비교
    so_that: 최적의 전략을 선택

  - id: US-003
    as: 분석가
    want: 백테스트 결과의 상세 지표 확인
    so_that: 전략의 강점/약점 파악

# ───────────────────────────────────────────────────────────────
# 나노인자 설계 (L0 → L3)
# ───────────────────────────────────────────────────────────────

nano_factors:
  L0_atoms:
    description: 기본 타입 정의
    components:
      - name: IStrategy
        purpose: 트레이딩 전략 정의
        fields:
          - id, name, description
          - entryConditions (진입 조건)
          - exitConditions (청산 조건)
          - positionSizing (포지션 크기)
          - riskManagement (리스크 관리)

      - name: IBacktestConfig
        purpose: 백테스트 설정
        fields:
          - startDate, endDate
          - initialCapital
          - symbols (대상 종목)
          - feeRate (수수료)
          - slippage (슬리피지)

      - name: IBacktestResult
        purpose: 백테스트 결과
        fields:
          - trades[] (거래 내역)
          - equity_curve (자산 곡선)
          - metrics (성과 지표)
          - drawdowns (낙폭 기록)

      - name: IPerformanceMetrics
        purpose: 성과 지표
        fields:
          - totalReturn, annualizedReturn
          - sharpeRatio, sortinoRatio
          - maxDrawdown, calmarRatio
          - winRate, profitFactor
          - avgWin, avgLoss

  L1_molecules:
    description: 계산 유틸리티
    components:
      - name: backtest-calc.ts
        functions:
          - calculateReturns (수익률 계산)
          - calculateSharpe (샤프 비율)
          - calculateSortino (소르티노 비율)
          - calculateDrawdown (낙폭 계산)
          - calculateWinRate (승률)
          - calculateProfitFactor (손익비)

      - name: signal-detector.ts
        functions:
          - evaluateCondition (조건 평가)
          - detectEntrySignal (진입 시그널)
          - detectExitSignal (청산 시그널)

  L2_cells:
    description: 서비스 및 저장소
    components:
      - name: price-data-service.ts
        purpose: 과거 가격 데이터 제공
        methods:
          - getHistoricalPrices
          - getOHLCV
          - resampleTimeframe

      - name: strategy-repository.ts
        purpose: 전략 저장/조회
        methods:
          - saveStrategy
          - getStrategy
          - listStrategies
          - deleteStrategy

      - name: backtest-result-repository.ts
        purpose: 백테스트 결과 저장
        methods:
          - saveResult
          - getResult
          - compareResults

  L3_tissues:
    description: 백테스트 실행 에이전트
    components:
      - name: BacktestAgent
        purpose: 백테스트 오케스트레이션
        methods:
          - runBacktest (백테스트 실행)
          - analyzeResult (결과 분석)
          - optimizeParameters (파라미터 최적화)
          - compareStrategies (전략 비교)

# ───────────────────────────────────────────────────────────────
# 백테스트 실행 흐름
# ───────────────────────────────────────────────────────────────

execution_flow:
  1_initialize:
    - 전략 로드
    - 가격 데이터 준비
    - 초기 자본 설정

  2_simulate:
    - 시간 순서대로 캔들 순회
    - 각 캔들에서 진입/청산 조건 평가
    - 시그널 발생 시 가상 거래 실행
    - 포지션 및 자산 업데이트

  3_calculate:
    - 전체 거래 내역 집계
    - 자산 곡선 생성
    - 성과 지표 계산
    - 낙폭 분석

  4_report:
    - 결과 저장
    - 시각화 데이터 생성
    - 인사이트 도출

# ───────────────────────────────────────────────────────────────
# 수락 기준
# ───────────────────────────────────────────────────────────────

acceptance_criteria:
  - 과거 1년 데이터로 백테스트 실행 가능
  - 일봉/4시간봉/1시간봉 타임프레임 지원
  - 수수료 및 슬리피지 반영
  - 샤프비율, 최대낙폭 등 핵심 지표 계산
  - 여러 전략 결과 비교 가능

# ───────────────────────────────────────────────────────────────
# 면책조항 (IMPORTANT)
# ───────────────────────────────────────────────────────────────

disclaimer: |
  ⚠️ 백테스트 결과는 과거 성과이며 미래 수익을 보장하지 않습니다.
  실제 투자 시 슬리피지, 유동성 등 추가 요인이 발생할 수 있습니다.
  이 시스템은 교육 목적으로만 사용되어야 합니다.
