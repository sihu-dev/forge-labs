# ============================================
# FORGE LABS 기능 명세서
# QUERY-003: sensor-optimizer
# 자가개선 성장 루프 (Self-Improving Growth Loop)
# ============================================

feature:
  id: "FEAT-2024-003"
  name: "sensor-optimizer"
  app: "dryon"
  priority: "P0"
  created: "2024-12-19"
  status: "analysis"
  pattern: "self-improving-growth-loop"

# ============================================
# 자가개선 성장 루프 아키텍처
# ============================================
#
#  ┌─────────────────────────────────────────────────────────────┐
#  │              SELF-IMPROVING GROWTH LOOP                      │
#  │                                                              │
#  │    ┌──────────┐    ┌──────────┐    ┌──────────┐             │
#  │    │  SENSE   │───▶│  DECIDE  │───▶│   ACT    │             │
#  │    │ (센서)   │    │ (분석)   │    │ (실행)   │             │
#  │    └──────────┘    └──────────┘    └──────────┘             │
#  │          ▲                               │                   │
#  │          │         ┌──────────┐          │                   │
#  │          └─────────│  LEARN   │◀─────────┘                   │
#  │                    │ (학습)   │                              │
#  │                    └──────────┘                              │
#  │                                                              │
#  │    피드백 루프: 실행 결과 → 학습 → 모델 개선 → 더 나은 결정    │
#  │                                                              │
#  └─────────────────────────────────────────────────────────────┘
#

# ============================================
# 1. 문제 정의
# ============================================
problem:
  statement: |
    슬러지 건조 공정에서 에너지 효율을 최적화하면서
    품질 기준을 만족하는 것이 어려움

  pain_points:
    - "수동 파라미터 조정으로 인한 비효율"
    - "운전자 경험 의존도가 높음"
    - "최적 조건을 찾기까지 많은 시행착오"
    - "환경 변화에 대한 적응이 느림"

  value_proposition: |
    자가개선 AI가 지속적으로 학습하여
    에너지 소비를 15-30% 절감하면서
    품질 기준을 자동으로 달성

# ============================================
# 2. 자가개선 루프 단계
# ============================================
growth_loop:
  # Phase 1: SENSE (감지)
  sense:
    description: "센서 데이터 수집 및 정규화"
    inputs:
      - "온도 센서 (입구/출구/건조실)"
      - "습도 센서"
      - "압력 센서"
      - "유량 센서"
      - "에너지 계측기"
    outputs:
      - "정규화된 센서 스트림"
      - "이상치 필터링된 데이터"
    frequency: "1초 간격"

  # Phase 2: DECIDE (결정)
  decide:
    description: "현재 상태 분석 및 최적 파라미터 결정"
    inputs:
      - "현재 센서 값"
      - "과거 데이터 패턴"
      - "학습된 최적화 모델"
    outputs:
      - "추천 파라미터 세트"
      - "예상 효과 (에너지 절감, 품질)"
      - "신뢰도 점수"
    logic:
      - "현재 상태 패턴 매칭"
      - "유사 상황 과거 결과 참조"
      - "최적 파라미터 예측"

  # Phase 3: ACT (실행)
  act:
    description: "파라미터 적용 및 결과 모니터링"
    inputs:
      - "추천 파라미터"
      - "운영자 승인 (선택)"
    outputs:
      - "실행 결과 로그"
      - "성능 메트릭"
    modes:
      - "자동 모드: 즉시 적용"
      - "반자동 모드: 승인 후 적용"
      - "모니터링 모드: 추천만 제공"

  # Phase 4: LEARN (학습)
  learn:
    description: "결과 분석 및 모델 개선"
    inputs:
      - "실행 전 상태"
      - "적용된 파라미터"
      - "실행 후 결과"
    outputs:
      - "업데이트된 최적화 모델"
      - "새로운 패턴 발견"
      - "신뢰도 조정"
    learning_types:
      - "지도 학습: 성공/실패 레이블링"
      - "강화 학습: 보상 기반 최적화"
      - "온라인 학습: 실시간 모델 업데이트"

# ============================================
# 3. 나노인자 분해
# ============================================
nano_factors:
  L0_atoms:
    - name: "SensorType"
      path: "packages/types/src/dryon/sensor.ts"
      description: "센서 종류 및 프로토콜 타입"

    - name: "ISensorReading"
      path: "packages/types/src/dryon/reading.ts"
      description: "센서 측정값 인터페이스"

    - name: "IOptimizationRecommendation"
      path: "packages/types/src/dryon/recommendation.ts"
      description: "최적화 추천 인터페이스"

    - name: "ILearningFeedback"
      path: "packages/types/src/dryon/feedback.ts"
      description: "학습 피드백 인터페이스 (핵심!)"

  L1_molecules:
    - name: "normalizeSensorData"
      path: "packages/utils/src/sensor.ts"
      description: "센서 데이터 정규화"

    - name: "detectAnomaly"
      path: "packages/utils/src/anomaly.ts"
      description: "이상치 감지 알고리즘"

    - name: "calculateEfficiency"
      path: "packages/utils/src/efficiency.ts"
      description: "에너지 효율 계산"

    - name: "computeReward"
      path: "packages/utils/src/reward.ts"
      description: "학습 보상 함수 (핵심!)"

  L2_cells:
    - name: "SensorCollectorService"
      path: "packages/core/src/services/sensor-collector-service.ts"
      description: "센서 데이터 수집 서비스"

    - name: "OptimizationModelService"
      path: "packages/core/src/services/optimization-model-service.ts"
      description: "최적화 모델 서비스"

    - name: "FeedbackRepository"
      path: "packages/core/src/repositories/feedback-repository.ts"
      description: "피드백 저장소 (학습 데이터)"

  L3_tissues:
    - name: "SensorOptimizerAgent"
      path: "apps/dryon/src/agents/sensor-optimizer-agent.ts"
      description: "자가개선 최적화 에이전트 (핵심!)"
      components:
        - "SenseModule: 센서 데이터 수집"
        - "DecideModule: 최적화 결정"
        - "ActModule: 파라미터 적용"
        - "LearnModule: 학습 및 개선"

# ============================================
# 4. 피드백 루프 메커니즘
# ============================================
feedback_loop:
  trigger: "매 최적화 실행 후"

  collect:
    - "before_state: 실행 전 상태"
    - "action: 적용된 파라미터"
    - "after_state: 실행 후 상태"
    - "duration: 관찰 기간"

  evaluate:
    metrics:
      - name: "energy_reduction"
        weight: 0.4
        target: ">= 10%"
      - name: "quality_maintained"
        weight: 0.4
        target: ">= 95%"
      - name: "stability"
        weight: 0.2
        target: "variance < 5%"

  update:
    - "성공 시: 해당 패턴 가중치 증가"
    - "실패 시: 해당 패턴 가중치 감소"
    - "새 패턴 발견 시: 모델에 추가"

  adapt:
    - "신뢰도 임계값 동적 조정"
    - "탐색/활용 비율 조정"
    - "계절/환경 변화 대응"

# ============================================
# 5. 학습 데이터 스키마
# ============================================
learning_schema:
  experience:
    id: "UUID"
    timestamp: "ISO8601"
    state:
      temperature_in: "number"
      temperature_out: "number"
      humidity: "number"
      pressure: "number"
      energy_consumption: "number"
    action:
      target_temp: "number"
      fan_speed: "number"
      feed_rate: "number"
    result:
      energy_saved: "number"
      quality_score: "number"
      stability_score: "number"
    reward: "number"

  pattern:
    id: "UUID"
    name: "string"
    conditions: "JSON (상태 조건)"
    recommended_action: "JSON (추천 액션)"
    success_count: "number"
    total_count: "number"
    confidence: "number (0-1)"
    last_updated: "ISO8601"

# ============================================
# 6. 성장 지표
# ============================================
growth_metrics:
  short_term:
    - "일별 에너지 절감률"
    - "추천 수용률"
    - "품질 달성률"

  long_term:
    - "모델 정확도 향상 추이"
    - "새로운 패턴 발견 수"
    - "자동화 비율 증가"

  self_improvement:
    - "학습 전후 성능 비교"
    - "환경 변화 적응 속도"
    - "예측 신뢰도 향상"

# ============================================
# 7. 안전 장치
# ============================================
safety:
  guardrails:
    - "파라미터 변경 범위 제한"
    - "급격한 변경 방지 (점진적 적용)"
    - "품질 하한선 보장"

  fallback:
    - "신뢰도 낮으면 수동 모드 전환"
    - "이상 감지 시 기본값 복원"
    - "운영자 오버라이드 항상 가능"

  monitoring:
    - "실시간 성능 대시보드"
    - "이상 알림"
    - "학습 진행 현황"

# ============================================
# 메타데이터
# ============================================
metadata:
  query_id: "QRY-2024-003"
  query_type: "feature-analysis"
  pattern: "self-improving-growth-loop"
  total_nano_factors: 12
  estimated_effort: "5일"
  complexity: "HIGH"
  innovation: "자가개선 피드백 루프 적용"
